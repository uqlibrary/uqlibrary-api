<link rel="import" href="elements.html">

<!--
Element providing facilities availability.

##### Example

    <uqlibrary-api-facilities-availability></uqlibrary-api-facilities-availability>

@element uqlibrary-api-facilities-availability
@blurb Element providing facilities availability.
@status alpha
@homepage https://github.com/uqlibrary/uqlibrary-api
-->
<dom-module id="uqlibrary-api-facilities-availability">
  <template>
    <uqlibrary-api id="facilities" uri="/facilities_availability"></uqlibrary-api>
  </template>
  <script>
    (function () {
      Polymer({
        is: 'uqlibrary-api-facilities-availability',
        properties: {
          /**
           * Fired when the object has loaded.
           */
          baseUri: {
            type: String,
            value: '/facilities_availability'
          }
        },
        created: function () {
        },
        ready: function () {
          var that = this;
          this.$.facilities.addEventListener('uqlibrary-api', function (e) {
            that.facilities = that._processData(e.detail);
            that.fire('uqlibrary-api-facilities-availability-loaded', that.facilities);
          });
        },
        /**
         * Cleans up the data from the API
         */
        _processData: function (data) {
          var s = JSON.stringify(data);

          var buildingReplacements = [
            {
              replace: [ "94" ],
              with: "Biological Sciences Library (#94)"
            },
            {
              replace: [ "Hawken Building 50" ],
              with: "Hawken Building (#50)"
            },
            {
              replace: [ "2, Duhig Tower" ],
              with: "Duhig Bldg (#2)"
            },
            {
              replace: [ "Duhig North (12)", "Duhig North 12", "Duhig North", "Duhig North12", "Duhig Bldg (#12)", "" ],
              with: "Duhig North Bldg (#12)"
            }
          ];

          // Replace building names
          for (var i = 0; i < buildingReplacements.length; i++) {
            var rightName = buildingReplacements[i].with;
            for (var j = 0; j < buildingReplacements[i].replace; j++) {
              s = s.replace('"building":"' + buildingReplacements[i].replace[j] + '"', '"building:"'+rightName+'"');
            }
          }

          var campusReplacements = [
            {
              replace: [ "ST LUCIA" ],
              with: "St Lucia"
            }
          ];

          // Replace campus names
          for (i = 0; i < campusReplacements.length; i++) {
            rightName = campusReplacements[i].with;
            for (j = 0; j < campusReplacements[i].replace; j++) {
              s = s.replace('"campus":"' + campusReplacements[i].replace[j] + '"', '"campus:"'+rightName+'"');
            }
          }

          return JSON.parse(s);
        },
        constructUrl: function (args, baseUrl) {
          var url = baseUrl;
          if (args && args.date) {
            url += '?date=' + args.date;
          }
          if (args && args.id && args.ptype) {
            url += url.indexOf('?') >= 0 ? '&' : '?';
            url += 'id=' + args.id;
            url += '&ptype=' + args.ptype;
          }
          if (args && args.nocache) {
            url += url.indexOf('?') >= 0 ? '&' : '?';
            url += 'nocache=true';
          }
          return url;
        },
        /**
         * Gets facilities availability.
         * args is optional parameter (as per facilities availability API):
         *  date - specify availability date DD-MM-YYYY
         *  id - specify user id, ptype - specify user type
         *  nocache - set to true to avoid using cached data
         * @method get
         */
        get: function (args) {
          var url = this.constructUrl(args, this.baseUri);
          this.set('$.facilities.uri', url);
          this.$.facilities.get({ addTimestamp: args && args.nocache });
        }
      });
    }());
  </script>
</dom-module>